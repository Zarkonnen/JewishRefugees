<!DOCTYPE html>
<html>
    <head>
        <title>Jewish Refugees</title>
        <style>
            html, body {
                height: 99%;
                margin: 0;
                padding: 0;
            }
            #map {
                height: 70%;
                margin-bottom: 1em;
            }
            td {
                padding-right: 1em;
            }
        </style>
        <script src="jquery-3.0.0.min.js"></script>
    </head>
    <body>
        <div id="sidebar" style="float: left; width: 30%; height: 100%; font-size: 70%; line-height: 140%; padding: 1em; padding-bottom: 0; overflow: auto;">
<b>VSJF-Refugees Migration Data</b> 
<p>This data is an excerpt of the VSJF-database hosted at the Archives of Contemporary History, ETH Zurich. The database contains data sets of refugees which have been registered by the „Association of Swiss Jewish Refugee Aid and Welfare Organizations“ (Verband Schweizerischer Jüdischer Fürsorgen, VSJF), a private organization for the aid to Jewish refugees founded 1925 and active to the present time.</p>

<p>In the map the movements of about 20'000 refugees situated in 535 locations in Switzerland are shown. Their movements can be traced over time in the period of 1898-1975 (based on the entry date).</p>

<p>The journey of a refugee starts with the place of birth and continues with the place from where Switzerland was entered (if known). Then the refugee stays in a series of camps or homes within Switzerland. On average a refugee visited 1 to 2 camps or homes. Finally, the refugee leaves Switzerland from a designated place to a destination abroad.</p>

<p>The data quality on stays abroad is less accurate because the data was unstructured text. Sometimes only the country and/or no date was stated. Yet 88% of the refugees have information on their stays abroad. In contrast, data on stays within Switzerland have been structured, but there is information on only 62% of the refugees.

<p>Due to missing information some of the dates had to be estimated, especially for the date of departure where only 60% have a date entry. The residences in Switzerland are grouped into 7 groups based on their type.</p>

<p><a href="http://make.opendata.ch/wiki/project:vsjfrefugees_migration" target="_blank">Project Entry</a>, <a href="https://github.com/Zarkonnen/JewishRefugees" target="_blank">GitHub</a></p>

<table>
    <tr>
        <td><img src="markers/ffaaaa-17.png"></td>
        <td>Imprisoned</td>
        <td><img src="markers/aaaaff-17.png"></td>
        <td>Minors</td>
    </tr>
    <tr>
        <td><img src="markers/ffaa00-17.png"></td>
        <td>Interned</td>
        <td><img src="markers/aaaaaa-17.png"></td>
        <td>General/Camps</td>
    </tr>
    <tr>
        <td><img src="markers/c47853-17.png"></td>
        <td>Labour</td>
        <td><img src="markers/ffffff-17.png"></td>
        <td>Other/Unknown</td>
    </tr>
    <tr>
        <td><img src="markers/aaffaa-17.png"></td>
        <td>Medical</td>
        <td><img src="markers/000000-17.png"></td>
        <td>Concentration Camp</td>
    </tr>
</table>
        </div>
        <div id="map"></div>
        <div id="footer">
            1898 <input type="submit" value="<" id="prev"><input type="range" id="daterange" value="-1041379200"><input type="submit" value=">" id="next"> 1975 <span id="currentdate"></span>
            <div id="event" style="float: right; padding-right: 1em;"></div>
        </div>
        <script>
            var map;
            var labelsOff = [{
                featureType: "administrative",
                elementType: "labels",
                stylers: [{
                    visibility: "on"
                }]
            }, {
                featureType: "poi",
                elementType: "all",
                stylers: [{
                    visibility: "off"
                }]
            }, {
                featureType: "water",
                elementType: "labels",
                stylers: [{
                    visibility: "off"
                }]
            }, {
                featureType: "road",
                elementType: "all",
                stylers: [{
                    visibility: "off"
                }]
            }];
            
            function parseDate(s) {
                return new Date(parseInt(s.split("-")[0]), parseInt(s.split("-")[1]) - 1, parseInt(s.split("-")[2]));
            }
            
            var people = [];
            var importantEvents = [];
            
            function getZoomLevel() {
                return Math.min(12, Math.max(2, Math.ceil(map.getZoom())));
            }
            
            function getClusterForZoomLevel(loc, place_index, zoomLevel) {
                var clusters = place_index[loc.name + loc.type];
                for (var i = 0; i < clusters.length; i++) {
                    if (clusters[i].zoomLevel == zoomLevel) {
                        return clusters[i];
                    }
                }
            }
            
            function inSameCluster(locA, locB, place_index, zoomLevel) {
                return getClusterForZoomLevel(locA, place_index, zoomLevel) == getClusterForZoomLevel(locB, place_index, zoomLevel);
            }
            
            function updateMap(place_index, famousPeople, jump) {
                var zoomLevel = getZoomLevel();
                var currentTime = parseInt(jQuery('#daterange').val());
                jQuery('#currentdate').html(" - " + ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][new Date(currentTime).getMonth()] + " " + new Date(currentTime).getFullYear());
                people.forEach(function(p) {
                    if (currentTime < p.locations[0].time.getTime()) {
                        if (p.marker != null) {
                            p.marker.setMap(null);
                            p.marker = null;
                        }
                        p.locationKey = null;
                        p.animating = false;
                    } else {
                        var loc = p.locations[0];
                        var newLocationIndex = 0;
                        for (var i = 0; i < p.locations.length; i++) {
                            if (currentTime >= p.locations[i].time.getTime()) {
                                loc = p.locations[i];
                                newLocationIndex = i;
                            }
                        }
                        if (!jump && p.locationIndex != -1 && p.locationIndex != newLocationIndex && !inSameCluster(p.locations[p.locationIndex], loc, place_index, zoomLevel)) {
                            p.animating = true;
                            p.animProgress = 0;
                            p.srcLat = getClusterForZoomLevel(p.locations[p.locationIndex], place_index, zoomLevel).lat;
                            p.srcLng = getClusterForZoomLevel(p.locations[p.locationIndex], place_index, zoomLevel).lng;
                            p.dstLat = getClusterForZoomLevel(loc, place_index, zoomLevel).lat;
                            p.dstLng = getClusterForZoomLevel(loc, place_index, zoomLevel).lng;
                        }
                        p.locationIndex = newLocationIndex;
                        p.locationKey = loc.name + loc.type;
                    }
                });
                
                famousPeople.forEach(function(p) {
                    if (currentTime < p.locations[0].time.getTime()) {
                        if (p.marker != null) {
                            p.marker.setMap(null);
                            p.marker = null;
                        }
                        p.animating = false;
                    } else {
                        var loc = p.locations[0];
                        var newLocationIndex = 0;
                        for (var i = 0; i < p.locations.length; i++) {
                            if (currentTime >= p.locations[i].time.getTime()) {
                                loc = p.locations[i];
                                newLocationIndex = i;
                            }
                        }
                        if (p.marker == null) {
                            p.marker = new google.maps.Marker({
                                position: loc.position,
                                map: map,
                                icon: 'people/' + p.icon
                            });
                            p.marker.addListener('click', function() {
                              p.infoWindow.open(map, p.marker);
                            });
                        }
                        if (p.locationIndex != -1 && p.locationIndex != newLocationIndex) {
                            p.animating = true;
                            p.animProgress = 0;
                            p.srcLat = p.locations[p.locationIndex].position.lat;
                            p.srcLng = p.locations[p.locationIndex].position.lng;
                            p.dstLat = loc.position.lat;
                            p.dstLng = loc.position.lng;
                        }
                        p.locationIndex = newLocationIndex;
                    }
                });
                
                var event = null;
                for (var i = 0; i < importantEvents.length; i++) {
                    var dist = Math.abs(currentTime - importantEvents[i].date.getTime());
                    if (dist < 1000 * 3600 * 24 * 18) {
                        event = importantEvents[i];
                    }
                }
                if (event == null) {
                    jQuery('#event').html('');
                } else {
                    jQuery('#event').html('<b>' + event.name + '</b> ' + event.rawDate + '<br><small><a href="' + event.wiki + '" target="_blank">Wikipedia</a></small><br><img src="' + event.image + '" height=150>');
                }
            }
            
            function recalculateClusterSizes(clusters, people, place_index) {
                for (var zl in clusters) {
                    clusters[zl].forEach(function(c) {
                        c.size = 0;
                        c.activeMembers = {};
                    });
                }
                people.forEach(function(p) {
                    if (p.locationKey) {
                        place_index[p.locationKey].forEach(function(c) {
                            c.size++;
                            if (!c.activeMembers[p.locationKey]) {
                                c.activeMembers[p.locationKey] = 1;
                            } else {
                                c.activeMembers[p.locationKey]++;
                            }
                        });
                    }
                });
            }
            
            function updateClusters(clusters) {
                var zoomLevel = getZoomLevel();
                for (var zl in clusters) {
                    if (zl == zoomLevel) {
                        clusters[zl].forEach(function(c) {
                            if (c.size == 0) {
                                if (c.marker) {
                                    c.marker.setMap(null);
                                    c.marker = null;
                                }
                            } else {
                                var sz = c.size > 99 ? "99+" : "" + c.size;
                                for (var i = 200; i <= 1000; i += 100) {
                                    if (c.size >= i) {
                                        sz = i + "+";
                                    }
                                }
                                for (var i = 2000; i <= 10000; i += 1000) {
                                    if (c.size >= i) {
                                        sz = i + "+";
                                    }
                                }
                                var color = null;
                                for (var m in c.activeMembers) {
                                    var colorForMember = c.colorByMember[m];
                                    if (color == null || color == colorForMember) {
                                        color = colorForMember;
                                    } else {
                                        color = "#aaaaaa";
                                    }
                                }
                                if (!c.marker) {
                                    c.marker = new google.maps.Marker({
                                        position: c,
                                        map: map,
                                        icon: 'markers/' + color.substring(1) + '-' + sz + '.png'
                                    });
                                    c.infoWindow = new google.maps.InfoWindow({
                                        content: ""
                                    });
                                    c.marker.addListener('click', function() {
                                      c.infoWindow.open(map, c.marker);
                                    });
                                } else if (c.markerSize != sz || c.markerColor != color) {
                                    c.marker.setIcon('markers/' + color.substring(1) + '-' + sz + '.png');
                                }
                                var info = "<b>" + c.size + " people</b><ul style=\"list-style: none; padding: 0;\">";
                                var memberKeys = [];
                                for (var m in c.activeMembers) {
                                    memberKeys.push(m);
                                }
                                memberKeys.sort(function(a, b) {
                                    return c.activeMembers[b] - c.activeMembers[a];
                                });
                                memberKeys.forEach(function(m) {
                                    info += c.info[m][0] + c.activeMembers[m] + c.info[m][1];
                                });
                                info += "</ul>";
                                c.infoWindow.setContent(info);
                                c.markerSize = sz;
                                c.markerColor = color;
                            }
                        });
                    } else {
                        clusters[zl].forEach(function(c) {
                            if (c.marker) {
                                c.marker.setMap(null);
                                c.marker = null;
                            }
                        });
                    }
                }
            }
          
            function initMap(rawData, rawGeocodes, clusters, famousPeople, rawImportantEvents) {
                importantEvents = rawImportantEvents.split("\n").filter(function(l) { return l.length > 1; }).map(function(l) {
                    l = l.split("\t");
                    return {
                        name: l[0],
                        date: parseDate(l[1]),
                        rawDate: l[1],
                        image: l[2],
                        wiki: l[3]
                    }
                });
            
                var place_index = {};
                for (var zl in clusters) {
                    clusters[zl].forEach(function(c) {
                        c.members.forEach(function(m) {
                            if (!place_index[m]) {
                                place_index[m] = [c];
                            } else {
                                place_index[m].push(c);
                            }
                        });
                        c.zoomLevel = zl;
                    });
                }
                var geocodes = {};
                rawGeocodes.split("\n").map(function(l) {
                    l = l.split("\t");
                    geocodes[l[0]] = {lat:parseFloat(l[1]), lng:parseFloat(l[2])};
                });
                famousPeople.forEach(function(fp) {
                    fp.locations.forEach(function(l) {
                        l.position = geocodes[l.name];
                        l.time = new Date(l.time, 1, 1);
                    });
                    fp.locationIndex = -1;
                    fp.marker = null;
                    fp.animating = false;
                    fp.animProgress = 0;
                    fp.srcLat = 0;
                    fp.srcLng = 0;
                    fp.dstLat = 0;
                    fp.dstLng = 0;
                    fp.infoWindow = new google.maps.InfoWindow({
                        content: "<h1>" + fp.name + "</h1><small><a href=\"" + fp.wiki + "\" target=\"_blank\">Wikipedia</a></small><br><img src=\"people/" + fp.image + "\" width=240>"
                    });
                });
                var data = rawData.split("\n").filter(function(l) {
                    return l.split("\t").length > 5;
                }).map(function(l) {
                    l = l.split("\t");
                    return {
                        id: parseInt(l[0]),
                        location: l[1],
                        time: parseDate(l[2]),
                        type: l[5]
                    };            
                });
                var peopleMap = {};
                data.forEach(function(l) {
                    if (!geocodes[l.location] || geocodes[l.location].lat == 0) { return; }
                    if (!peopleMap[l.id]) {
                        var person = {
                            id: l.id,
                            locations: [],
                            locationIndex: -1,
                            marker: null,
                            animating: false,
                            animProgress: 0,
                            srcLat: 0, srcLng: 0,
                            dstLat: 0, dstLng: 0
                        };
                        peopleMap[l.id] = person;
                        people.push(person);
                    }
                    peopleMap[l.id].locations.push({
                        name: l.location,
                        time: l.time,
                        type: l.type,
                        position: geocodes[l.location]
                    });
                });
                
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 46.801111, lng: 8.226667},
                    zoom: 8
                });
                
                map.setOptions({styles: labelsOff});
                
                map.addListener("zoom_changed", function() {
                    updateClusters(clusters);
                });

                people.forEach(function(p) {
                    p.locations.sort(function(a, b) {
                        return a.time.getTime() - b.time.getTime();
                    });
                });
                
                jQuery('#prev').click(function() {
                    jQuery('#daterange').val(parseInt(jQuery('#daterange').val()) - 3600 * 24 * 30 * 1000);
                    updateMap(place_index, famousPeople, false);
                    recalculateClusterSizes(clusters, people, place_index);
                    updateClusters(clusters);
                });
                
                jQuery('#next').click(function() {
                    jQuery('#daterange').val(parseInt(jQuery('#daterange').val()) + 3600 * 24 * 30 * 1000);
                    updateMap(place_index, famousPeople, false);
                    recalculateClusterSizes(clusters, people, place_index);
                    updateClusters(clusters);
                });
                
                jQuery('#daterange').attr('min', new Date(1898, 1, 1).getTime()).attr('max', new Date(1975, 12, 31).getTime()).val(new Date(1939, 1, 1).getTime()).change(function() {
                    updateMap(place_index, famousPeople, true);
                    recalculateClusterSizes(clusters, people, place_index);
                    updateClusters(clusters);
                });
                
                updateMap(place_index, famousPeople, true);
                recalculateClusterSizes(clusters, people, place_index);
                updateClusters(clusters);
                
                setInterval(function() {
                    for (var i = 0; i < people.length; i++) {
                        var person = people[i];
                        if (!person.animating) { continue; }
                        person.animProgress = Math.min(1, person.animProgress + 0.025);
                        var position = { lat: person.srcLat * (1 - person.animProgress) + person.dstLat * person.animProgress, lng: person.srcLng * (1 - person.animProgress) + person.dstLng * person.animProgress };
                        if (person.marker == null) {
                            person.marker = new google.maps.Marker({
                                position: position,
                                map: map,
                                icon: 'markers/aaaaaa-1.png'
                            });
                        } else {
                            person.marker.setPosition(position);
                        }
                        person.animating = person.animProgress < 1;
                        if (!person.animating) {
                            person.marker.setMap(null);
                            person.marker = null;
                        }
                    }
                    for (var i = 0; i < famousPeople.length; i++) {
                        var person = famousPeople[i];
                        if (!person.animating) { continue; }
                        person.animProgress = Math.min(1, person.animProgress + 0.025);
                        var position = { lat: person.srcLat * (1 - person.animProgress) + person.dstLat * person.animProgress, lng: person.srcLng * (1 - person.animProgress) + person.dstLng * person.animProgress };
                        person.marker.setPosition(position);
                        person.animating = person.animProgress < 1;
                    }
                }, 15);
            }

            function loadData() {
                jQuery.ajax({
                    "url": "data.tsv",
                    "success": function(rawData) {
                        jQuery.ajax({
                            "url": "geocodes.tsv",
                            "success": function(rawGeocodes) {
                                jQuery.ajax({
                                    "url": "clusters.json",
                                    "success": function(clusters) {
                                        jQuery.ajax({
                                            "url": "famous_people.json",
                                            "success": function(famousPeople) {
                                                jQuery.ajax({
                                                    "url": "important_events.tsv",
                                                    "success": function(rawImportantEvents) {
                                                        initMap(rawData, rawGeocodes, clusters, famousPeople, rawImportantEvents);
                                                    }
                                                });
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
            }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQ8YLJ3J5CcGUBB9t9SdL-bSJRrbD_3po&callback=loadData"
        async defer></script>
    </body>
</html>

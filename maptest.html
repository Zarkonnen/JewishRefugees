<!DOCTYPE html>
<html>
    <head>
        <title>Jewish Refugees</title>
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #map {
                height: 80%;
            }
        </style>
        <script src="jquery-3.0.0.min.js"></script>
    </head>
    <body>
        <div id="map"></div>
        <div id="footer">
            1898 <input type="submit" value="<" id="prev"><input type="range" id="daterange" value="-1041379200"><input type="submit" value=">" id="next"> 1975 <span id="currentdate"></span>
        </div>
        <script>
            var map;
            var labelsOff = [{
                featureType: "administrative",
                elementType: "labels",
                stylers: [{
                    visibility: "on"
                }]
            }, {
                featureType: "poi",
                elementType: "all",
                stylers: [{
                    visibility: "off"
                }]
            }, {
                featureType: "water",
                elementType: "labels",
                stylers: [{
                    visibility: "off"
                }]
            }, {
                featureType: "road",
                elementType: "all",
                stylers: [{
                    visibility: "off"
                }]
            }];
            
            function parseDate(s) {
                return new Date(parseInt(s.split("-")[0]), parseInt(s.split("-")[1]), parseInt(s.split("-")[2]));
            }
            
            var people = [];
            
            function updateMap() {
                var currentTime = parseInt(jQuery('#daterange').val());
                jQuery('#currentdate').html(" - " + ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][new Date(currentTime).getMonth()] + " " + new Date(currentTime).getFullYear());
                people.forEach(function(p) {
                    if (currentTime < p.locations[0].time.getTime()) {
                        if (p.marker.getIcon() != 'no_marker.png') {
                            p.marker.setIcon('no_marker.png');
                        }
                    } else {
                        var loc = p.locations[0];
                        var newLocationIndex = 0;
                        for (var i = 0; i < p.locations.length; i++) {
                            if (currentTime >= p.locations[i].time.getTime()) {
                                loc = p.locations[i];
                                newLocationIndex = i;
                            }
                        }
                        if (p.marker.getIcon() == 'no_marker.png') {
                            p.marker.setIcon('tiny_marker.png');
                            p.marker.setPosition(loc.position);
                        } else if (p.locationIndex != newLocationIndex) {
                            p.animating = true;
                            p.animProgress = 0;
                            p.srcLat = p.marker.getPosition().lat();
                            p.srcLng = p.marker.getPosition().lng();
                            p.dstLat = loc.position.lat;
                            p.dstLng = loc.position.lng;
                        }
                        p.locationIndex = newLocationIndex;
                    }
                });
            }
          
            function initMap(rawData, rawGeocodes, rawClusters) {
                var geocodes = {};
                rawGeocodes.split("\n").map(function(l) {
                    l = l.split("\t");
                    geocodes[l[0]] = {lat:parseFloat(l[1]), lng:parseFloat(l[2])};
                });
                var data = rawData.split("\n").filter(function(l) {
                    return l.split("\t").length > 5;
                }).map(function(l) {
                    l = l.split("\t");
                    return {
                        id: parseInt(l[0]),
                        location: l[1],
                        time: parseDate(l[2]),
                        type: l[5]
                    };            
                });
                var peopleMap = {};
                data.forEach(function(l) {
                    if (!geocodes[l.location] || geocodes[l.location].lat == 0) { return; }
                    if (!peopleMap[l.id]) {
                        var person = {
                            id: l.id,
                            locations: [],
                            locationIndex: 0,
                            marker: null,
                            animating: false,
                            animProgress: 0,
                            srcLat: 0, srcLng: 0,
                            dstLat: 0, dstLng: 0
                        };
                        peopleMap[l.id] = person;
                        people.push(person);
                    }
                    peopleMap[l.id].locations.push({
                        name: l.location,
                        time: l.time,
                        type: l.type,
                        position: geocodes[l.location]
                    });
                });
                
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 46.801111, lng: 8.226667},
                    zoom: 8
                });
                
                rawClusters[12].forEach(function(c) {
                    new google.maps.Marker({
                        position: c,
                        map: map,
                        icon: 'markers/' + c["color"].substring(1) + '-20.png'
                    });
                });
                
                map.setOptions({styles: labelsOff});

                people.forEach(function(p) {
                    p.locations.sort(function(a, b) {
                        return a.time.getTime() - b.time.getTime();
                    });
                    p.marker = new google.maps.Marker({
                        position: p.locations[0].position,
                        map: map,
                        icon: 'tiny_marker.png'
                    });
                });
                
                jQuery('#prev').click(function() {
                    jQuery('#daterange').val(parseInt(jQuery('#daterange').val()) - 3600 * 24 * 30 * 1000);
                    updateMap();
                });
                
                jQuery('#next').click(function() {
                    jQuery('#daterange').val(parseInt(jQuery('#daterange').val()) + 3600 * 24 * 30 * 1000);
                    updateMap();
                });
                
                jQuery('#daterange').attr('min', new Date(1898, 1, 1).getTime()).attr('max', new Date(1975, 12, 31).getTime()).val(new Date(1939, 1, 1).getTime()).change(updateMap);
                updateMap();
                
                setInterval(function() {
                    for (var i = 0; i < people.length; i++) {
                        var person = people[i];
                        if (!person.animating) { continue; }
                        person.animProgress = Math.min(1, person.animProgress + 0.025);
                        var position = { lat: person.srcLat * (1 - person.animProgress) + person.dstLat * person.animProgress, lng: person.srcLng * (1 - person.animProgress) + person.dstLng * person.animProgress };
                        person.marker.setPosition(position);
                        person.animating = person.animProgress < 1;
                    }
                }, 15);
            }

            function loadData() {
                jQuery.ajax({
                    "url": "data.tsv",
                    "success": function(rawData) {
                        jQuery.ajax({
                            "url": "geocodes_switzerland.tsv",
                            "success": function(rawGeocodes) {
                                jQuery.ajax({
                                    "url": "clusters.json",
                                    "success": function(rawClusters) {
                                        initMap(rawData, rawGeocodes, rawClusters);
                                    }
                                });
                            }
                        });
                    }
                });
            }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQ8YLJ3J5CcGUBB9t9SdL-bSJRrbD_3po&callback=loadData"
        async defer></script>
    </body>
</html>

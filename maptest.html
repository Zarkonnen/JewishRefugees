<!DOCTYPE html>
<html>
    <head>
        <title>Jewish Refugees</title>
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #map {
                height: 80%;
            }
        </style>
        <script src="jquery-3.0.0.min.js"></script>
    </head>
    <body>
        <div id="map"></div>
        <div id="footer">
            1898 <input type="submit" value="<" id="prev"><input type="range" id="daterange"><input type="submit" value=">" id="next"> 1975 <span id="currentdate"></span>
        </div>
        <script>
            var map;
            var labelsOff = [{
                featureType: "administrative",
                elementType: "labels",
                stylers: [{
                    visibility: "on"
                }]
            }, {
                featureType: "poi",
                elementType: "all",
                stylers: [{
                    visibility: "off"
                }]
            }, {
                featureType: "water",
                elementType: "labels",
                stylers: [{
                    visibility: "off"
                }]
            }, {
                featureType: "road",
                elementType: "all",
                stylers: [{
                    visibility: "off"
                }]
            }];
            
            function parseDate(s) {
                return new Date(parseInt(s.split("-")[0]), parseInt(s.split("-")[1]), parseInt(s.split("-")[2]));
            }
            
            var people = [];
            
            function updateMap() {
                var currentTime = parseInt(jQuery('#daterange').val());
                jQuery('#currentdate').html(" - " + ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][new Date(currentTime).getMonth()] + " " + new Date(currentTime).getFullYear());
                people.forEach(function(p) {
                    if (currentTime < p.locations[0].time.getTime()) {
                        if (p.marker.getIcon() != 'no_marker.png') {
                            p.marker.setIcon('no_marker.png');
                        }
                    } else {
                        p.marker.setIcon('tiny_marker.png');
                        var loc = p.locations[0];
                        for (var i = 0; i < p.locations.length; i++) {
                            if (currentTime >= p.locations[i].time.getTime()) {
                                loc = p.locations[i];
                            }
                        }
                        p.marker.setPosition(loc.position);
                    }
                });
            }
          
            function initMap(rawData, rawGeocodes) {
                var geocodes = {};
                rawGeocodes.split("\n").map(function(l) {
                    l = l.split("\t");
                    geocodes[l[0]] = {lat:parseFloat(l[1]), lng:parseFloat(l[2])};
                });
                var data = rawData.split("\n").filter(function(l) {
                    return l.split("\t").length > 5;
                }).map(function(l) {
                    l = l.split("\t");
                    return {
                        id: parseInt(l[0]),
                        location: l[1],
                        time: parseDate(l[2]),
                        type: l[5]
                    };            
                });
                var peopleMap = {};
                data.forEach(function(l) {
                    if (!geocodes[l.location] || geocodes[l.location].lat == 0) { return; }
                    if (!peopleMap[l.id]) {
                        var person = {
                            id: l.id,
                            locations: [],
                            marker: null
                        };
                        peopleMap[l.id] = person;
                        people.push(person);
                    }
                    peopleMap[l.id].locations.push({
                        name: l.location,
                        time: l.time,
                        type: l.type,
                        position: geocodes[l.location]
                    });
                });
                
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 46.801111, lng: 8.226667},
                    zoom: 8
                });
                
                map.setOptions({styles: labelsOff});

                people.forEach(function(p) {
                    p.locations.sort(function(a, b) {
                        return a.time.getTime() - b.time.getTime();
                    });
                    p.marker = new google.maps.Marker({
                        position: p.locations[0].position,
                        map: map,
                        icon: 'tiny_marker.png'
                    });
                });
                /*var mi = 0;
                setInterval(function() {
                    var marker = markers[mi++ % 100];
                    var oldPosition = marker.getPosition();
                    var newPosition = { lat: Math.random() * 180 - 90, lng: Math.random() * 360 - 180 };
                    var lerp = 0.0;
                    var anim = setInterval(function() {
                        if (lerp >= 1) {
                            clearInterval(anim);
                            return;
                        }
                        lerp = Math.min(1, lerp + 0.004);
                        var position = { lat: oldPosition.lat() * (1 - lerp) + newPosition.lat * lerp, lng: oldPosition.lng() * (1 - lerp) + newPosition.lng * lerp };
                        marker.setPosition(position);
                    }, 15);
                }, 3000);*/
                
                jQuery('#prev').click(function() {
                    jQuery('#daterange').val(parseInt(jQuery('#daterange').val()) - 3600 * 24 * 30 * 1000);
                    updateMap();
                });
                
                jQuery('#next').click(function() {
                    jQuery('#daterange').val(parseInt(jQuery('#daterange').val()) + 3600 * 24 * 30 * 1000);
                    updateMap();
                });
                
                jQuery('#daterange').attr('min', new Date(1898, 1, 1).getTime()).attr('max', new Date(1975, 12, 31).getTime()).change(updateMap);
                updateMap();
            }

            function loadData() {
                jQuery.ajax({
                    "url": "data.tsv",
                    "success": function(rawData) {
                        jQuery.ajax({
                            "url": "geocodes.tsv",
                            "success": function(rawGeocodes) {
                                initMap(rawData, rawGeocodes);
                            }
                        });
                    }
                });
            }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQ8YLJ3J5CcGUBB9t9SdL-bSJRrbD_3po&callback=loadData"
        async defer></script>
    </body>
</html>

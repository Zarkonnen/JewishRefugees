<!DOCTYPE html>
<html>
    <head>
        <title>Jewish Refugees</title>
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #map {
                height: 80%;
            }
        </style>
        <script src="jquery-3.0.0.min.js"></script>
    </head>
    <body>
        <div id="map"></div>
        <div id="footer">
            1898 <input type="submit" value="<" id="prev"><input type="range" id="daterange" value="-1041379200"><input type="submit" value=">" id="next"> 1975 <span id="currentdate"></span>
        </div>
        <script>
            var map;
            var labelsOff = [{
                featureType: "administrative",
                elementType: "labels",
                stylers: [{
                    visibility: "on"
                }]
            }, {
                featureType: "poi",
                elementType: "all",
                stylers: [{
                    visibility: "off"
                }]
            }, {
                featureType: "water",
                elementType: "labels",
                stylers: [{
                    visibility: "off"
                }]
            }, {
                featureType: "road",
                elementType: "all",
                stylers: [{
                    visibility: "off"
                }]
            }];
            
            function parseDate(s) {
                return new Date(parseInt(s.split("-")[0]), parseInt(s.split("-")[1]), parseInt(s.split("-")[2]));
            }
            
            var people = [];
            
            function updateMap() {
                var currentTime = parseInt(jQuery('#daterange').val());
                jQuery('#currentdate').html(" - " + ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][new Date(currentTime).getMonth()] + " " + new Date(currentTime).getFullYear());
                people.forEach(function(p) {
                    if (currentTime < p.locations[0].time.getTime()) {
                        if (p.marker != null) {
                            p.marker.setMap(null);
                            p.marker = null;
                        }
                        p.locationKey = null;
                        p.animating = false;
                    } else {
                        var loc = p.locations[0];
                        var newLocationIndex = 0;
                        for (var i = 0; i < p.locations.length; i++) {
                            if (currentTime >= p.locations[i].time.getTime()) {
                                loc = p.locations[i];
                                newLocationIndex = i;
                            }
                        }
                        if (p.locationIndex != -1 && p.locationIndex != newLocationIndex) {
                            p.animating = true;
                            p.animProgress = 0;
                            p.srcLat = p.locations[p.locationIndex].position.lat;
                            p.srcLng = p.locations[p.locationIndex].position.lng;
                            p.dstLat = loc.position.lat;
                            p.dstLng = loc.position.lng;
                        }
                        p.locationIndex = newLocationIndex;
                        p.locationKey = loc.name + loc.type;
                    }
                });
            }
            
            function recalculateClusterSizes(clusters, people, place_index) {
                for (var zl in clusters) {
                    clusters[zl].forEach(function(c) {
                        c.size = 0;
                    });
                }
                people.forEach(function(p) {
                    if (p.locationKey) {
                        place_index[p.locationKey].forEach(function(c) {
                            c.size++;
                        });
                    }
                });
            }
            
            function updateClusters(clusters) {
                var zoomLevel = Math.min(12, Math.max(5, Math.ceil(map.getZoom())));
                for (var zl in clusters) {
                    if (zl == zoomLevel) {
                        clusters[zl].forEach(function(c) {
                            if (c.size == 0) {
                                if (c.marker) {
                                    c.marker.setMap(null);
                                    c.marker = null;
                                }
                            } else {
                                var sz = c.size > 99 ? "99+" : "" + c.size;
                                if (!c.marker) {
                                    c.marker = new google.maps.Marker({
                                        position: c,
                                        map: map,
                                        icon: 'markers/' + c["color"].substring(1) + '-' + sz + '.png'
                                    });
                                } else {
                                    c.marker.setIcon('markers/' + c["color"].substring(1) + '-' + sz + '.png');
                                }
                            }
                        });
                    } else {
                        clusters[zl].forEach(function(c) {
                            if (c.marker) {
                                c.marker.setMap(null);
                                c.marker = null;
                            }
                        });
                    }
                }
            }
          
            function initMap(rawData, rawGeocodes, clusters) {
                var place_index = {};
                for (var zl in clusters) {
                    clusters[zl].forEach(function(c) {
                        c.members.forEach(function(m) {
                            if (!place_index[m]) {
                                place_index[m] = [c];
                            } else {
                                place_index[m].push(c);
                            }
                        });
                    });
                }
                var geocodes = {};
                rawGeocodes.split("\n").map(function(l) {
                    l = l.split("\t");
                    geocodes[l[0]] = {lat:parseFloat(l[1]), lng:parseFloat(l[2])};
                });
                var data = rawData.split("\n").filter(function(l) {
                    return l.split("\t").length > 5;
                }).map(function(l) {
                    l = l.split("\t");
                    return {
                        id: parseInt(l[0]),
                        location: l[1],
                        time: parseDate(l[2]),
                        type: l[5]
                    };            
                });
                var peopleMap = {};
                data.forEach(function(l) {
                    if (!geocodes[l.location] || geocodes[l.location].lat == 0) { return; }
                    if (!peopleMap[l.id]) {
                        var person = {
                            id: l.id,
                            locations: [],
                            locationIndex: -1,
                            marker: null,
                            animating: false,
                            animProgress: 0,
                            srcLat: 0, srcLng: 0,
                            dstLat: 0, dstLng: 0
                        };
                        peopleMap[l.id] = person;
                        people.push(person);
                    }
                    peopleMap[l.id].locations.push({
                        name: l.location,
                        time: l.time,
                        type: l.type,
                        position: geocodes[l.location]
                    });
                });
                
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 46.801111, lng: 8.226667},
                    zoom: 8
                });
                
                map.setOptions({styles: labelsOff});
                
                map.addListener("zoom_changed", function() {
                    updateClusters(clusters);
                });

                people.forEach(function(p) {
                    p.locations.sort(function(a, b) {
                        return a.time.getTime() - b.time.getTime();
                    });
                });
                
                jQuery('#prev').click(function() {
                    jQuery('#daterange').val(parseInt(jQuery('#daterange').val()) - 3600 * 24 * 30 * 1000);
                    updateMap();
                    recalculateClusterSizes(clusters, people, place_index);
                    updateClusters(clusters);
                });
                
                jQuery('#next').click(function() {
                    jQuery('#daterange').val(parseInt(jQuery('#daterange').val()) + 3600 * 24 * 30 * 1000);
                    updateMap();
                    recalculateClusterSizes(clusters, people, place_index);
                    updateClusters(clusters);
                });
                
                jQuery('#daterange').attr('min', new Date(1898, 1, 1).getTime()).attr('max', new Date(1975, 12, 31).getTime()).val(new Date(1939, 1, 1).getTime()).change(function() {
                    updateMap();
                    recalculateClusterSizes(clusters, people, place_index);
                    updateClusters(clusters);
                });
                
                updateMap();
                recalculateClusterSizes(clusters, people, place_index);
                updateClusters(clusters);
                
                setInterval(function() {
                    for (var i = 0; i < people.length; i++) {
                        var person = people[i];
                        if (!person.animating) { continue; }
                        person.animProgress = Math.min(1, person.animProgress + 0.025);
                        var position = { lat: person.srcLat * (1 - person.animProgress) + person.dstLat * person.animProgress, lng: person.srcLng * (1 - person.animProgress) + person.dstLng * person.animProgress };
                        if (person.marker == null) {
                            person.marker = new google.maps.Marker({
                                position: position,
                                map: map,
                                icon: 'markers/cccccc-1.png'
                            });
                        } else {
                            person.marker.setPosition(position);
                        }
                        person.animating = person.animProgress < 1;
                        if (!person.animating) {
                            person.marker.setMap(null);
                            person.marker = null;
                        }
                    }
                }, 15);
            }

            function loadData() {
                jQuery.ajax({
                    "url": "data.tsv",
                    "success": function(rawData) {
                        jQuery.ajax({
                            "url": "geocodes_switzerland.tsv",
                            "success": function(rawGeocodes) {
                                jQuery.ajax({
                                    "url": "clusters.json",
                                    "success": function(clusters) {
                                        initMap(rawData, rawGeocodes, clusters);
                                    }
                                });
                            }
                        });
                    }
                });
            }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQ8YLJ3J5CcGUBB9t9SdL-bSJRrbD_3po&callback=loadData"
        async defer></script>
    </body>
</html>

<!DOCTYPE html>
<html>
    <head>
        <title>Jewish Refugees</title>
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #map {
                height: 100%;
            }
        </style>
        <script src="jquery-3.0.0.min.js"></script>
    </head>
    <body>
        <div id="map"></div>
        <script>
            var map;
            var labelsOff = [{
                featureType: "administrative",
                elementType: "labels",
                stylers: [{
                    visibility: "on"
                }]
            }, {
                featureType: "poi",
                elementType: "all",
                stylers: [{
                    visibility: "off"
                }]
            }, {
                featureType: "water",
                elementType: "labels",
                stylers: [{
                    visibility: "off"
                }]
            }, {
                featureType: "road",
                elementType: "all",
                stylers: [{
                    visibility: "off"
                }]
            }];
          
            function initMap(rawData, rawGeocodes) {
                var geocodes = {};
                rawGeocodes.split("\n").map(function(l) {
                    l = l.split("\t");
                    geocodes[l[0]] = {lat:parseFloat(l[1]), lng:parseFloat(l[2])};
                });
                var data = rawData.split("\n").map(function(l) {
                    l = l.split("\t");
                    return {
                        id: parseInt(l[0]),
                        location: l[1],
                        time: l[2],
                        type: l[5]
                    };            
                });
                var peopleMap = {};
                var people = [];
                data.forEach(function(l) {
                    if (!peopleMap[l.id]) {
                        var person = {
                            id: l.id,
                            locations: [],
                            marker: null
                        };
                        peopleMap[l.id] = person;
                        people.push(person);
                    }
                    peopleMap[l.id].locations.push({
                        name: l.location,
                        time: l.time,
                        type: l.type,
                        position: geocodes[l.location]
                    });
                });
                
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 40, lng: 0},
                    zoom: 7
                });
                
                map.setOptions({styles: labelsOff});

                people.forEach(function(p) {
                    //console.log(p.locations[0].position);
                    p.marker = new google.maps.Marker({
                        position: p.locations[0].position,
                        map: map,
                        icon: 'tiny_marker.png'
                    });
                });
                /*var markers = [];
                for (var i = 0; i < 100; i++) {
                    markers.push(new google.maps.Marker({
                        position: { lat: Math.random() * 180 - 90, lng: Math.random() * 360 - 180 },
                        map: map,
                        icon: 'tiny_marker.png'
                    }));
                }*/
                /*var mi = 0;
                setInterval(function() {
                    var marker = markers[mi++ % 100];
                    var oldPosition = marker.getPosition();
                    var newPosition = { lat: Math.random() * 180 - 90, lng: Math.random() * 360 - 180 };
                    var lerp = 0.0;
                    var anim = setInterval(function() {
                        if (lerp >= 1) {
                            clearInterval(anim);
                            return;
                        }
                        lerp = Math.min(1, lerp + 0.004);
                        var position = { lat: oldPosition.lat() * (1 - lerp) + newPosition.lat * lerp, lng: oldPosition.lng() * (1 - lerp) + newPosition.lng * lerp };
                        marker.setPosition(position);
                    }, 15);
                }, 3000);*/
            }

            function loadData() {
                jQuery.ajax({
                    "url": "data.tsv",
                    "success": function(rawData) {
                        jQuery.ajax({
                            "url": "geocodes.tsv",
                            "success": function(rawGeocodes) {
                                initMap(rawData, rawGeocodes);
                            }
                        });
                    }
                });
            }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQ8YLJ3J5CcGUBB9t9SdL-bSJRrbD_3po&callback=loadData"
        async defer></script>
    </body>
</html>
